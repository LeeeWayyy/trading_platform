# P1.1T5 Implementation Guide: Operational Status Command

**Task:** Create `make status` wrapper for operational overview
**Status:** ✅ Complete
**Completed:** October 18, 2024
**Effort:** < 1 day
**PR:** [Link to PR]

---

## Table of Contents

1. [Overview](#overview)
2. [Problem Statement](#problem-statement)
3. [Solution Architecture](#solution-architecture)
4. [Implementation Details](#implementation-details)
5. [Usage Examples](#usage-examples)
6. [Key Learnings](#key-learnings)
7. [Related Documentation](#related-documentation)

---

## Overview

This task implemented the `make status` command that provides a unified operational overview of the trading platform by querying health endpoints and aggregating data from all services.

**Why This Matters:**
- **Operational Visibility:** Quick view of platform health without manual API queries
- **Troubleshooting:** Immediately see which services are down
- **Monitoring:** At-a-glance view of positions, P&L, and recent activity
- **Developer Experience:** Single command replaces multiple curl commands

**What Changed:**
- Created `scripts/operational_status.sh` bash script (237 lines)
- Updated `Makefile` to call the script
- Queries all service health endpoints
- Displays positions, recent runs, and P&L summary
- Color-coded output with emojis for readability

---

## Problem Statement

### Before (P0 MVP Implementation)

```bash
# Had to manually query each service
$ curl http://localhost:8001/health  # Signal Service
$ curl http://localhost:8002/health  # Execution Gateway
$ curl http://localhost:8003/health  # Orchestrator
$ curl http://localhost:8002/api/v1/positions  # Positions
$ curl http://localhost:8003/api/v1/orchestration/runs  # Recent runs

# Makefile had placeholder
$ make status
Status command not yet implemented (T5+)
```

**Problems:**
1. No unified view of platform status
2. Manual querying is tedious and error-prone
3. Hard to quickly assess system health
4. JSON responses not human-readable

---

## Solution Architecture

### Design Decisions

1. **Bash Script for Simplicity**
   - No additional dependencies beyond jq and curl
   - Easy to modify and extend
   - Works on macOS and Linux
   - Can be called from Makefile or directly

2. **Query Multiple Services**
   - Health checks: All three services (T3, T4, T5)
   - Positions: Execution Gateway `/api/v1/positions`
   - Recent runs: Orchestrator `/api/v1/orchestration/runs`
   - P&L summary: Execution Gateway `/api/v1/positions/pnl`

3. **Human-Readable Output**
   - ANSI colors for visual hierarchy
   - Emojis for quick scanning
   - Formatted tables for structured data
   - Color-coded P&L (green for profit, red for loss)

4. **Graceful Degradation**
   - Continue showing data even if some services are down
   - Display warnings for unreachable services
   - Non-zero exit code if any service unhealthy

### Script Architecture

```
┌─────────────────────────────────────────────────────────────┐
│              operational_status.sh Flow                      │
└─────────────────────────────────────────────────────────────┘

1. Check Dependencies
   └─> Verify jq and curl are installed

2. Service Health Checks
   ├─> Query Signal Service /health
   ├─> Query Execution Gateway /health
   └─> Query Orchestrator /health

3. Positions (from T4)
   └─> GET /api/v1/positions
       Parse and display each position

4. Recent Runs (from T5)
   └─> GET /api/v1/orchestration/runs?limit=5
       Parse and display latest runs

5. P&L Summary (from T4)
   └─> GET /api/v1/positions/pnl
       Color-code based on profit/loss

6. Exit Code
   └─> 0 if all healthy, 1 if any degraded
```

---

## Implementation Details

### File Created

**`scripts/operational_status.sh`** (237 lines)

Key functions:

```bash
# Check if jq and curl are installed
check_dependencies()

# Query service health endpoint with timeout
check_service_health(service_name, url, timeout)

# Get and format positions from Execution Gateway
get_positions()

# Get and format recent runs from Orchestrator
get_recent_runs()

# Get and format P&L with color coding
get_pnl_summary()
```

### Color Scheme

```bash
# Service status
GREEN   = Healthy (✓)
RED     = Unreachable (✗)
YELLOW  = Degraded (⚠️)

# P&L values
GREEN   = Positive value
RED     = Negative value

# Emojis
🔧 = Services section
📊 = Positions section
📋 = Recent runs section
💰 = P&L section
```

### Environment Variables

The script supports custom service URLs:

```bash
# Override default URLs
export SIGNAL_SERVICE_URL="http://custom:8001"
export EXECUTION_GATEWAY_URL="http://custom:8002"
export ORCHESTRATOR_URL="http://custom:8003"

./scripts/operational_status.sh
```

### Exit Codes

```bash
0 - All services healthy
1 - One or more services unhealthy or unreachable
2 - Missing dependencies (jq or curl)
```

---

## Usage Examples

### Basic Usage

```bash
$ make status

========================================================================
  TRADING PLATFORM STATUS
========================================================================

🔧 Services:
✓ Signal Service (T3): healthy
✓ Execution Gateway (T4): healthy
✓ Orchestrator (T5): healthy

📊 Positions (T4):
  AAPL: 100 shares @ $150.00 avg
  MSFT: -50 shares @ $300.00 avg

📋 Recent Runs (T5):
  2025-01-17 09:00: SUCCESS
  2025-01-16 09:00: SUCCESS

💰 Latest P&L:
  Realized:    +$1,234.56
  Unrealized:  +$150.00
  Total:       +$1,384.56

========================================================================
```

### When Services Are Down

```bash
$ make status

========================================================================
  TRADING PLATFORM STATUS
========================================================================

🔧 Services:
✗ Signal Service (T3): unreachable (is service running?)
✓ Execution Gateway (T4): healthy
✗ Orchestrator (T5): unreachable (is service running?)

📊 Positions (T4):
  No open positions

📋 Recent Runs (T5):
⚠️ Unable to fetch recent runs (HTTP 000)

💰 Latest P&L:
  Realized:    $0.00
  Unrealized:  $0.00
  Total:       $0.00

========================================================================
```

### Direct Script Execution

```bash
$ ./scripts/operational_status.sh
# Same output as make status

$ echo $?
1  # Exit code 1 because some services were down
```

### Custom Service URLs

```bash
$ EXECUTION_GATEWAY_URL=http://prod-server:8002 ./scripts/operational_status.sh
# Queries production server instead of localhost
```

---

## Key Learnings

### 1. Bash for Operational Scripts

**Lesson:** Bash is perfect for operational scripts that query APIs and format output.

**Rationale:**
- No compilation required
- Available on all Unix-like systems
- Easy to modify for quick fixes
- Standard tools (curl, jq) are widely available

### 2. Graceful Degradation is Critical

**Lesson:** The script continues working even when some services are down.

**Implementation:**
```bash
# Each function handles errors independently
check_service_health "Service A" "$URL" || all_healthy=1
# Script continues even if this fails

get_positions || true  # Don't exit if positions unavailable
```

### 3. Human-Readable Output Matters

**Lesson:** Colors and emojis make output much easier to scan quickly.

**Best Practice:**
- Use ANSI colors for status (green=good, red=bad, yellow=warning)
- Use emojis as visual anchors for each section
- Format numbers with $ for currency
- Color-code P&L based on profit/loss

### 4. Timeouts Prevent Hanging

**Lesson:** Always set timeouts for HTTP requests in operational scripts.

**Implementation:**
```bash
curl -s --max-time 3 "$url/health"
# Times out after 3 seconds instead of hanging indefinitely
```

### 5. Exit Codes Enable Automation

**Lesson:** Exit codes allow scripts to be chained or used in monitoring.

**Usage:**
```bash
# In monitoring script
if ! ./scripts/operational_status.sh &> /dev/null; then
    echo "Platform unhealthy!" | mail -s "Alert" ops@example.com
fi
```

---

## Related Documentation

### Implementation Guides
- [P0 Paper Run](./t6-paper-run.md) - Main paper trading script that uses these APIs
- [P1.1T1 Enhanced P&L](./p1.1t1-enhanced-pnl.md) - P&L calculation that this script displays

### Concepts
- None required (operational tooling)

### Code Files
- `scripts/operational_status.sh` - Operational status script
- `Makefile` - Updated with status target

---

## Acceptance Criteria

All acceptance criteria from P1_PLANNING.md were met:

- [x] `make status` shows complete overview
- [x] Formatted output with colors
- [x] Health checks for all services
- [x] Error handling for service downtime
- [x] Documentation updated

---

## Summary Statistics

**Files Created:** 1 script file
**Files Modified:** 1 (Makefile)
**Lines of Code:** 237 lines (bash)
**Time to Implement:** < 1 day
**Dependencies:** jq, curl (standard tools)
**Breaking Changes:** None

---

**Task Status:** ✅ Complete
**Next Task:** Track 2 - Real-Time Data or Risk Management
**Related PR:** [Link to PR when created]

