# T2.2 Covariance Estimation - Implementation Plan (v2)

## Overview
Implement factor covariance estimation and specific risk calculation for the risk model.

## Codex Review v2 Feedback Addressed

### 1. SpecificRiskEstimator API Alignment
**Issue:** Task spec requires `estimate(as_of_date, factor_cov, factor_loadings) -> DataFrame`
**Fix:** Updated signature to match spec exactly:
```python
def estimate(
    self,
    as_of_date: date,
    factor_cov: np.ndarray,          # Shrunk/HAC-adjusted covariance from FactorCovarianceEstimator
    factor_loadings: pl.DataFrame,   # Factor exposures per stock (permno, factor_name, loading)
) -> pl.DataFrame:
```

### 2. Missing Doc Deliverable
**Issue:** Plan omits `docs/CONCEPTS/covariance-estimation.md`
**Fix:** Added to deliverables with outline:
- Factor return extraction methodology
- Exponential decay weighting explanation
- Ledoit-Wolf shrinkage theory
- Newey-West HAC correction
- Specific risk derivation
- PSD enforcement
- Usage examples

### 3. PSD Repair Detail
**Issue:** "Floor negative eigenvalues at 0" lacks reconstruction step
**Fix:** Explicit algorithm:
```python
def _ensure_psd(cov: np.ndarray) -> np.ndarray:
    """Ensure covariance matrix is positive semi-definite."""
    # 1. Eigendecomposition
    eigenvalues, eigenvectors = np.linalg.eigh(cov)

    # 2. Clip negative eigenvalues to small positive value
    eigenvalues_clipped = np.maximum(eigenvalues, 1e-10)

    # 3. Reconstruct symmetric PSD matrix
    cov_psd = eigenvectors @ np.diag(eigenvalues_clipped) @ eigenvectors.T

    # 4. Ensure perfect symmetry (numerical)
    cov_psd = (cov_psd + cov_psd.T) / 2

    return cov_psd
```

### 4. HAC + Decay Ordering Clarity
**Issue:** Unclear computation order, potential double-weighting
**Fix:** Explicit computation pipeline:
```
Step 1: Compute RAW factor returns from cross-sectional regression (no weighting)
Step 2: Apply exponential decay weights to RAW returns for weighted covariance
Step 3: Apply Newey-West HAC correction to the WEIGHTED covariance
Step 4: Apply Ledoit-Wolf shrinkage to the HAC-adjusted covariance
```
**Rationale:** HAC corrects for autocorrelation in the decay-weighted series. Decay weights are NOT passed into `cov_hac` - instead, we pre-weight the returns, compute sample covariance, then apply HAC adjustment to that covariance estimate.

**Test:** `test_hac_decay_ordering_produces_expected_variance` - Compare variance estimates with/without HAC on autocorrelated synthetic data.

### 5. Data-Quality Edge Cases
**Issue:** Missing handling for bad data days
**Fix:** Added explicit handling:
- **Days with <min_stocks:** Skip day, log warning, do not include in factor returns
- **NaN/inf in exposures:** Filter out affected stocks for that day, log count
- **NaN/inf in returns:** Filter out affected stocks for that day, log count
- **Missing factors:** If any factor has <min_stocks valid exposures, skip entire day
- **Validation:** Add `_validate_daily_inputs()` method called before each regression

**Tests:**
- `test_skips_days_with_insufficient_stocks`
- `test_handles_nan_in_exposures`
- `test_handles_nan_in_returns`
- `test_handles_inf_values`
- `test_logs_skipped_days`

---

## Previous Feedback Items (Still Addressed)

### Intercept in Regression
- Model: `ret_i,t = alpha_t + sum(beta_i,k * f_k,t) + epsilon_i,t`
- Intercept captures cross-sectional average return

### Canonical Factor Ordering
- `CANONICAL_FACTOR_ORDER = ['momentum_12_1', 'book_to_market', 'roe', 'log_market_cap', 'realized_vol']`
- All matrices use this ordering consistently

### Negative Residual Variance Handling
- Floor specific variance at `1e-8`, log warning

### HAC Application
- Newey-West applied to factor return time-series covariance

### PIT/Versioning Tests
- Comprehensive PIT tests included

### Storage Contract
- Matches P4T2_TASK.md schema exactly

---

## Implementation Details

### File 1: libs/risk/__init__.py
```python
"""Risk analytics module for factor covariance and specific risk estimation."""

from libs.risk.factor_covariance import (
    CovarianceConfig,
    CovarianceResult,
    FactorCovarianceEstimator,
)
from libs.risk.specific_risk import (
    SpecificRiskEstimator,
    SpecificRiskResult,
)

__all__ = [
    "CovarianceConfig",
    "CovarianceResult",
    "FactorCovarianceEstimator",
    "SpecificRiskEstimator",
    "SpecificRiskResult",
]
```

### File 2: libs/risk/factor_covariance.py

**Constants:**
```python
CANONICAL_FACTOR_ORDER = [
    'momentum_12_1',
    'book_to_market',
    'roe',
    'log_market_cap',
    'realized_vol',
]
```

**CovarianceConfig:**
- `halflife_days: int = 60` - Exponential decay half-life
- `min_observations: int = 126` - Minimum trading days required
- `newey_west_lags: int = 5` - HAC lag parameter
- `shrinkage_target: str = "identity"` - Shrinkage target matrix
- `shrinkage_intensity: float | None = None` - None = Ledoit-Wolf optimal
- `min_stocks_per_day: int = 100` - Minimum stocks for valid regression

**CovarianceResult:**
- `factor_covariance: np.ndarray` - K x K covariance matrix (PSD guaranteed)
- `factor_names: list[str]` - Factor names in canonical order
- `factor_returns: pl.DataFrame` - Daily factor returns
- `as_of_date: date`
- `dataset_version_ids: dict[str, str]`
- `computation_timestamp: datetime`
- `shrinkage_intensity: float` - Actual shrinkage applied
- `effective_observations: int` - Weighted observation count
- `reproducibility_hash: str`
- `skipped_days: list[date]` - Days skipped due to data quality

**FactorCovarianceEstimator methods:**

1. `__init__(factor_builder, config)`
   - Store reference to FactorBuilder for exposure retrieval
   - Initialize config with defaults

2. `_validate_daily_inputs(exposures, returns, date) -> tuple[pl.DataFrame, pl.DataFrame, list[str]]`
   - Filter out NaN/inf from exposures and returns
   - Check min_stocks_per_day threshold
   - Return (clean_exposures, clean_returns, warnings)
   - Raise `InsufficientDataError` if <min_stocks remain

3. `estimate_factor_returns(start_date, end_date) -> pl.DataFrame`
   - For each day t in [start_date, end_date]:
     - Get factor exposures from t-1 (lagged, PIT correct)
     - Get stock returns at t
     - Call `_validate_daily_inputs()` - skip day if insufficient
     - Run WLS regression with intercept: `ret = alpha + exposures @ betas + epsilon`
     - Weights: sqrt(market_cap) for each stock
     - Store betas as factor returns for day t
     - Store t-statistics, R-squared
   - Return DataFrame: date, factor_name, daily_return, t_statistic, r_squared

4. `estimate_covariance(as_of_date) -> CovarianceResult`
   - Get factor returns for [as_of_date - lookback, as_of_date]
   - Compute exponential decay weights: `w_t = exp(-ln(2) * age_t / halflife)`
   - Compute weighted sample covariance
   - Apply Newey-West HAC to weighted covariance
   - Apply Ledoit-Wolf shrinkage
   - Ensure PSD via `_ensure_psd()`
   - Return CovarianceResult

5. `_compute_weighted_covariance(factor_returns, weights) -> np.ndarray`
   - De-mean with weighted mean
   - Compute weighted outer products
   - Sum and normalize by sum of weights

6. `_apply_newey_west_to_covariance(weighted_cov, factor_returns, weights) -> np.ndarray`
   - Apply HAC adjustment using statsmodels
   - Adjust for autocorrelation in factor return series

7. `_apply_ledoit_wolf_shrinkage(cov) -> tuple[np.ndarray, float]`
   - Use sklearn.covariance.LedoitWolf
   - Return (shrunk_cov, shrinkage_intensity)

8. `_ensure_psd(cov) -> np.ndarray`
   - Eigendecomposition
   - Clip negative eigenvalues to 1e-10
   - Reconstruct: V @ diag(clipped) @ V.T
   - Symmetrize: (M + M.T) / 2

9. `validate(cov_matrix) -> list[str]`
   - Check all eigenvalues >= 0 (PSD)
   - Check correlations in [-1, 1]
   - Check no NaN/inf values
   - Return list of errors

10. `to_storage_format() -> pl.DataFrame`
    - Convert to long format: as_of_date, factor_i, factor_j, covariance, correlation, ...
    - Include all required metadata columns

### File 3: libs/risk/specific_risk.py

**SpecificRiskResult:**
- `specific_risks: pl.DataFrame` - permno, specific_variance, specific_vol
- `as_of_date: date`
- `dataset_version_ids: dict[str, str]`
- `computation_timestamp: datetime`
- `coverage: float` - % of universe with valid specific risk
- `reproducibility_hash: str`
- `floored_count: int` - Number of stocks with floored variance

**SpecificRiskEstimator methods:**

1. `__init__(config: CovarianceConfig)`
   - Store config for halflife, min_observations

2. `estimate(as_of_date, factor_cov, factor_loadings) -> SpecificRiskResult`
   **Signature matches task spec exactly**
   - `factor_cov: np.ndarray` - K x K factor covariance (from FactorCovarianceEstimator)
   - `factor_loadings: pl.DataFrame` - permno, factor_name, loading (from FactorBuilder)
   - For each stock:
     - Get factor loadings as K-vector (in canonical order)
     - Compute factor contribution to variance: `b.T @ factor_cov @ b`
     - Get historical stock returns
     - Compute total variance with exponential decay
     - Specific variance = total_variance - factor_variance
     - Floor at 1e-8 if negative (log warning, increment floored_count)
     - Specific vol = sqrt(specific_variance) * sqrt(252)
   - Return SpecificRiskResult

3. `validate() -> list[str]`
   - Check no negative variances (should be floored)
   - Check no NaN/inf values
   - Check reasonable range (annualized vol < 500%)

4. `to_storage_format() -> pl.DataFrame`
   - Match schema: as_of_date, permno, specific_variance, specific_vol, dataset_version_id

### File 4: docs/CONCEPTS/covariance-estimation.md

**Outline:**
1. Introduction to Factor Covariance Estimation
2. Cross-Sectional Regression for Factor Returns
   - WLS with sqrt(market_cap) weights
   - Intercept interpretation
   - Lagged exposures for PIT correctness
3. Exponential Decay Weighting
   - Half-life parameter
   - Weight formula
4. Ledoit-Wolf Shrinkage
   - Why shrinkage is needed
   - Optimal shrinkage intensity
5. Newey-West HAC Correction
   - Autocorrelation in factor returns
   - Lag selection
6. PSD Enforcement
   - Eigenvalue clipping
   - Matrix reconstruction
7. Specific Risk Estimation
   - Total variance decomposition
   - Residual variance calculation
8. Usage Examples
   - Computing covariance for portfolio optimization
   - Stress testing with factor shocks

---

## Test Plan

### test_factor_covariance.py

**TestFactorCovarianceEstimatorInit:**
- test_default_config
- test_custom_config
- test_canonical_factor_order_defined

**TestValidateDailyInputs:**
- test_filters_nan_exposures
- test_filters_nan_returns
- test_filters_inf_values
- test_raises_on_insufficient_stocks
- test_logs_filtered_count

**TestEstimateFactorReturns:**
- test_basic_factor_return_extraction
- test_includes_intercept_in_regression
- test_wls_weights_are_sqrt_market_cap
- test_uses_lagged_exposures
- test_skips_days_with_insufficient_stocks
- test_handles_nan_in_exposures
- test_handles_nan_in_returns
- test_handles_inf_values
- test_logs_skipped_days
- test_output_has_required_columns

**TestEstimateCovariance:**
- test_basic_covariance_estimation
- test_exponential_decay_weighting
- test_covariance_is_psd
- test_correlations_in_bounds

**TestComputationOrdering:**
- test_hac_decay_ordering_produces_expected_variance
- test_decay_applied_before_hac
- test_shrinkage_applied_after_hac

**TestEnsurePSD:**
- test_psd_repair_eigendecomposition
- test_psd_repair_reconstruction
- test_psd_repair_preserves_symmetry
- test_psd_already_valid_unchanged

**TestEstimateWithShrinkage:**
- test_ledoit_wolf_shrinkage
- test_shrinkage_improves_condition_number
- test_shrinkage_intensity_returned

**TestNeweyWest:**
- test_hac_correction_applied
- test_hac_reduces_autocorrelation_bias

**TestValidation:**
- test_validate_catches_nan
- test_validate_catches_inf
- test_validate_catches_non_psd
- test_validate_catches_correlation_out_of_bounds

**TestPITCorrectness:**
- test_different_as_of_dates_produce_different_results
- test_reproducibility_hash_same_inputs
- test_dataset_version_ids_propagated
- test_snapshot_date_raises_not_implemented

**TestStorageFormat:**
- test_to_storage_format_matches_schema
- test_storage_includes_all_metadata
- test_factor_returns_storage_schema

**TestPerformance:**
- test_500_stocks_under_10_seconds

### test_specific_risk.py

**TestSpecificRiskEstimatorInit:**
- test_default_config
- test_custom_config

**TestEstimateSignature:**
- test_accepts_factor_cov_and_loadings
- test_uses_shrunk_covariance

**TestEstimate:**
- test_basic_specific_risk_estimation
- test_residual_based_calculation
- test_negative_variance_floored
- test_floored_count_tracked
- test_annualized_volatility_correct
- test_uses_canonical_factor_order

**TestValidation:**
- test_validate_no_negative_variance
- test_validate_no_nan_inf
- test_validate_reasonable_range

**TestStorageFormat:**
- test_to_storage_format_matches_schema

**TestCoverage:**
- test_coverage_metric_correct

### test_docs.py (smoke test)

**TestDocumentation:**
- test_covariance_estimation_md_exists
- test_covariance_estimation_md_has_required_sections

---

## Files to Create (Complete List)

1. `libs/risk/__init__.py`
2. `libs/risk/factor_covariance.py`
3. `libs/risk/specific_risk.py`
4. `tests/libs/risk/__init__.py`
5. `tests/libs/risk/conftest.py`
6. `tests/libs/risk/test_factor_covariance.py`
7. `tests/libs/risk/test_specific_risk.py`
8. `docs/CONCEPTS/covariance-estimation.md`

---

## Dependencies

- **statsmodels**: For Newey-West HAC correction (needs to be added to pyproject.toml)
- **scipy**: For WLS regression (already installed)
- **sklearn**: For Ledoit-Wolf shrinkage (already installed)
- **numpy**: For matrix operations (already installed)
- **polars**: For data manipulation (already installed)

---

## Acceptance Criteria Mapping

| Criterion | Implementation |
|-----------|----------------|
| Daily factor return via cross-sectional regression | `estimate_factor_returns()` with intercept |
| Exponential decay weighting | `halflife_days` config, decay formula |
| Newey-West HAC | `_apply_newey_west_to_covariance()` using statsmodels |
| Ledoit-Wolf shrinkage | `_apply_ledoit_wolf_shrinkage()` using sklearn |
| Specific risk per stock | `SpecificRiskEstimator.estimate(as_of_date, factor_cov, factor_loadings)` |
| PSD validation | `_ensure_psd()` with eigenvalue clipping + reconstruction |
| validate() method | Checks nulls, infs, correlations, PSD |
| <10s for 500 stocks | Performance test |
| dataset_version_id metadata | All outputs include version tracking |
| >90% coverage | Comprehensive test suite |
| docs/CONCEPTS/covariance-estimation.md | Included with outline |
