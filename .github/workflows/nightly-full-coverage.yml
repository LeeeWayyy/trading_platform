name: Nightly Full Coverage

# This workflow runs a comprehensive coverage report including integration tests
# Results are INFORMATIONAL only - they don't block PRs but provide visibility

on:
  schedule:
    - cron: '0 3 * * *'  # 3 AM UTC daily
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read

jobs:
  # ============================================================================
  # Full Coverage Run (including integration tests)
  # ============================================================================
  full-coverage:
    name: Full Coverage Report
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: trading_platform
          POSTGRES_PASSWORD: dev_password
          POSTGRES_DB: trading_platform_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://trading_platform:dev_password@localhost:5432/trading_platform_test
      REDIS_URL: redis://localhost:6379
      ALPACA_USE_MOCK: "true"
      ALPACA_API_KEY: "mock_key_for_ci"
      ALPACA_SECRET_KEY: "mock_secret_for_ci"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry config virtualenvs.create false
          poetry install --with dev

      - name: Initialize database schema
        run: |
          if [ -f db/alembic.ini ]; then
            poetry run alembic upgrade head
          fi

      - name: Run all tests with coverage (including integration)
        run: |
          PYTHONPATH=. poetry run pytest \
            tests/ \
            --cov=libs --cov=apps \
            --cov-branch \
            --cov-report=xml:coverage-full.xml \
            --cov-report=html:htmlcov-full \
            --cov-report=term-missing \
            -v || true

      - name: Generate coverage summary
        run: |
          echo "# Nightly Full Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          coverage report --format=markdown >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Coverage report generation failed" >> $GITHUB_STEP_SUMMARY

      - name: Upload full coverage HTML report
        uses: actions/upload-artifact@v4
        with:
          name: full-coverage-report
          path: htmlcov-full/
          retention-days: 7

      - name: Upload coverage XML
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage-full.xml
          retention-days: 7

  # ============================================================================
  # P0 Quarantine Check - Run quarantined P0 tests nightly
  # ============================================================================
  p0-quarantine-check:
    name: P0 Quarantine Check
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: trading_platform
          POSTGRES_PASSWORD: dev_password
          POSTGRES_DB: trading_platform_test
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry config virtualenvs.create false
          poetry install --with dev

      - name: Run quarantined P0 tests
        run: |
          # P0 tests in quarantine still run nightly
          if [ -f tests/quarantine.txt ]; then
            P0_TESTS=$(grep -E "libs/(trading|risk)|apps/execution_gateway" tests/quarantine.txt 2>/dev/null | grep -v '^#' | cut -d'|' -f1 || true)
            if [ -n "$P0_TESTS" ]; then
              echo "## Quarantined P0 Tests" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Running the following quarantined P0 tests:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$P0_TESTS" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              PYTHONPATH=. poetry run pytest $P0_TESTS --no-cov -v || true
            else
              echo "✓ No P0 tests in quarantine" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "✓ No quarantine file found" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # Coverage Trend Analysis
  # ============================================================================
  coverage-trend:
    name: Coverage Trend Analysis
    needs: [full-coverage]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download coverage XML
        uses: actions/download-artifact@v4
        with:
          name: coverage-xml

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install coverage
        run: pip install coverage

      - name: Analyze coverage trend
        run: |
          echo "## Coverage Trend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract overall coverage from XML
          if [ -f coverage-full.xml ]; then
            COVERAGE=$(python3 -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage-full.xml')
          root = tree.getroot()
          line_rate = float(root.get('line-rate', 0)) * 100
          branch_rate = float(root.get('branch-rate', 0)) * 100
          print(f'Line: {line_rate:.1f}%')
          print(f'Branch: {branch_rate:.1f}%')
          " 2>/dev/null || echo "Could not parse coverage XML")
            echo "**Current Coverage:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$COVERAGE" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Coverage XML not found" >> $GITHUB_STEP_SUMMARY
          fi

          # Compare against baseline
          if [ -f scripts/testing/coverage_baselines.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Baseline:** $(python3 -c "import json; print(json.load(open('scripts/testing/coverage_baselines.json'))['overall'])")%" >> $GITHUB_STEP_SUMMARY
          fi
