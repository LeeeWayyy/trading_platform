name: CI - E2E Tests

# Run E2E tests that require full Docker service stack
# Unit tests and integration tests are handled by ci-tests-parallel.yml
#
# This workflow runs E2E tests which:
# - Build Docker images for all services
# - Start the full service stack (signal_service, execution_gateway, etc.)
# - Run tests in tests/e2e/ with @pytest.mark.e2e marker

on:
  pull_request:
    branches: [master, main]
    paths:
      # Only run e2e tests when relevant code changes
      - 'apps/**'
      - 'libs/**'
      - 'tests/e2e/**'
      - 'docker-compose*.yml'
      - 'Dockerfile*'
      - '.github/workflows/ci-tests-coverage.yml'
  push:
    branches: [master, main]
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # Unit tests, linting, and coverage are handled by ci-tests-parallel.yml
  # This workflow only runs E2E tests that require full Docker service stack

  e2e-tests:
    name: Run E2E tests (Docker stack)
    runs-on: ubuntu-latest

    steps:
      - name: Maximize disk space on runner
        uses: mathio/gha-cleanup@v1
        with:
          remove-browsers: true
          verbose: true

      - name: Disk space after cleanup
        run: |
          echo "::group::Disk space after cleanup"
          df -h
          echo "::endgroup::"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python for requirements generation
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate requirements.txt from pyproject.toml
        run: |
          pip install poetry poetry-plugin-export
          poetry export -f requirements.txt --output requirements.txt --without-hashes
          echo "Generated requirements.txt from pyproject.toml"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Free Docker cache before builds
        run: |
          echo "::group::Pruning Docker cache before builds"
          sudo docker system prune -af --volumes
          sudo docker builder prune -af
          echo "::endgroup::"

      - name: Build Docker images
        run: |
          echo "::group::Building Docker images for integration tests"
          docker compose -f docker-compose.ci.yml build
          echo "::endgroup::"

      - name: Start database for migrations
        run: |
          echo "::group::Starting PostgreSQL for migrations"
          docker compose -f docker-compose.ci.yml up -d postgres
          echo "Waiting for PostgreSQL to be healthy..."
          timeout 60 sh -c 'until docker compose -f docker-compose.ci.yml exec -T postgres pg_isready -U trader; do sleep 2; done'
          echo "::endgroup::"

      - name: Run database migrations
        run: |
          echo "::group::Running database migrations"
          # Run foundational migrations first (001-003), then newer migrations (0001+)
          # Legacy migrations create base tables: model_registry, orders, positions, orchestration_runs
          for migration in db/legacy/migrations_pre_alembic/*.sql; do
            echo "Running legacy migration: $migration"
            cat "$migration" | docker compose -f docker-compose.ci.yml exec -T postgres psql -U trader -d trader_test
          done

          # Newer migrations extend the schema with additional columns and tables
          for migration in db/migrations/*.sql; do
            echo "Running migration: $migration"
            cat "$migration" | docker compose -f docker-compose.ci.yml exec -T postgres psql -U trader -d trader_test
          done
          echo "::endgroup::"

      - name: Start services
        run: |
          echo "::group::Starting services with docker compose"
          docker compose -f docker-compose.ci.yml up -d
          echo "::endgroup::"

      - name: Wait for services to be healthy
        uses: ./.github/actions/wait-for-services
        with:
          compose-file: docker-compose.ci.yml
          max-iterations: 30
          sleep-seconds: 4
          fail-on-timeout: true

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install test dependencies
        run: |
          # Always use the same interpreter that runs pytest to avoid mismatched envs
          python -m pip install --upgrade pip
          # Use python -m pip to ensure installs land in the runner Python (not a Poetry venv)
          python -m pip install -r requirements.txt
          # Install additional test dependencies
          python -m pip install pytest pytest-cov pytest-asyncio httpx

      - name: Run E2E integration tests
        run: |
          echo "::group::Running E2E integration tests"
          python -m pytest tests/e2e/ -v -m e2e --tb=short
          echo "::endgroup::"

      - name: Capture service logs on failure
        if: failure()
        run: |
          echo "::group::Service logs (signal_service)"
          docker compose -f docker-compose.ci.yml logs signal_service
          echo "::endgroup::"

          echo "::group::Service logs (execution_gateway)"
          docker compose -f docker-compose.ci.yml logs execution_gateway
          echo "::endgroup::"

          echo "::group::Service logs (orchestrator)"
          docker compose -f docker-compose.ci.yml logs orchestrator
          echo "::endgroup::"

      - name: Stop services
        if: always()
        run: |
          echo "::group::Stopping services"
          docker compose -f docker-compose.ci.yml down -v
          echo "::endgroup::"

      - name: Integration test summary
        if: success()
        run: |
          echo "## Integration Tests ðŸ”—" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Service health checks: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Signal generation: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Service communication: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Orchestrator workflow: Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All services started successfully and E2E tests passed." >> $GITHUB_STEP_SUMMARY
